<!-- HTML header for doxygen 1.8.17-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>rack: Working with images</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="rack.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="rack-logo-110x55.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname"><!-- rack /-->
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Working with images </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#image_basic_ops">Basic image operations</a><ul><li class="level2"><a href="#rescale">Extracting images from data</a></li>
</ul>
</li>
<li class="level1"><a href="#palette">Creating coloured images</a></li>
<li class="level1"><a href="#transparency">Adding transparency</a></li>
<li class="level1"><a href="#drainimage">Image processing commands</a><ul><li class="level2"><a href="#howimages">How it works internally</a></li>
<li class="level2"><a href="#imageOps">List of image operators</a></li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><p>This section handles image processing. See also a separate section for <a class="el" href="fileiopage.html#fileio_img">Reading and writing image files</a> .</p>
<h1><a class="anchor" id="image_basic_ops"></a>
Basic image operations</h1>
<h2><a class="anchor" id="rescale"></a>
Extracting images from data</h2>
<p>As mentioned in <a class="el" href="fileiopage.html#fileio_img">Reading and writing image files</a>, data can be extracted and stored as image files simply by selecting data and issuing <code>&ndash;outputFile</code> ( <code>-o</code> ) command: </p><div class="fragment"><div class="line"><a class="code" href="namespacerack.html">rack</a> volume.h5 --select quantity=DBZH  -o sweep.png</div>
</div><!-- fragment --><p>If a user wishes to rescale intensities, The scaling and special codes are defined with <code>&ndash;encoding</code> .</p>
<div class="fragment"><div class="line"><a class="code" href="namespacerack.html">rack</a> volume.h5 --select quantity=DBZH --encoding C,0.25,-32.0 --image -o sweep-rescaled.png</div>
</div><!-- fragment --><p>Notice that this command will not affect the actual radar data (HDF5 structure) in memory. (The one <code>&ndash;image</code> command required in earlier versions of rack is called implicitly.) For converting the actual data, use <code>&ndash;convert</code> as explained in <a class="el" href="index.html#conversions">Data conversions</a> .</p>
<div class="image">
<img src="sweep-rescaled.png" alt=""/>
<div class="caption">
A sweep with rescaled intensities.</div></div>
 <h1><a class="anchor" id="palette"></a>
Creating coloured images</h1>
<p>A colour palette can be added by loading a text file consisting of lines that contain a threshold followed by red, green and blue values. The format is compatible with that of <code>color-relief</code> command used by <code>gdaldem</code> (<a href="https://gdal.org/programs/gdaldem.html">https://gdal.org/programs/gdaldem.html</a>) The file may contain comments escaped by a hash. For example, a file containing </p><div class="fragment"><div class="line"><span class="preprocessor"># dBZ</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="preprocessor"># undetect</span></div>
<div class="line">@ 0   0   0</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor"># nodata</span></div>
<div class="line">@ 255 255 255 </div>
<div class="line"> </div>
<div class="line"><span class="preprocessor"># noise</span></div>
<div class="line">-32.0   0   0   0  </div>
<div class="line">-24.0   60 140 200</div>
<div class="line">-16.0   10 155 225</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor"># insects</span></div>
<div class="line">-8.0    5 205 170</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor"># drizzle</span></div>
<div class="line">0.0 140 230  20 </div>
<div class="line"> </div>
<div class="line"><span class="preprocessor"># weak</span></div>
<div class="line">8.0 240 240  20 </div>
<div class="line"> </div>
<div class="line"><span class="preprocessor"># rain</span></div>
<div class="line">16.0    255 205  20 </div>
<div class="line"> </div>
<div class="line"><span class="preprocessor"># moderate</span></div>
<div class="line">24.0    255 150  50 </div>
<div class="line"> </div>
<div class="line"><span class="preprocessor"># intensive</span></div>
<div class="line">32.0    255  80  60 </div>
<div class="line"> </div>
<div class="line"><span class="preprocessor"># hail</span></div>
<div class="line">40.0    250 120 255 </div>
<div class="line"><span class="preprocessor"># </span></div>
<div class="line">60.0    255 255 255</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
</div><!-- fragment --><p> can be applied for colouring a sweep using the following command: </p><div class="fragment"><div class="line"><a class="code" href="namespacerack.html">rack</a> volume.h5 --select dataset1,quantity=DBZH  --palette palette-DBZH.txt -o sweep-rgb.png</div>
</div><!-- fragment --><p>The resulting image is stored in the HDF5 structure in parallel with the source data, in the next available <code>data{i}</code> group. (In earlier versions: in a separate image object.) The resulting quantity &ndash; <code>what:quantity</code> &ndash; is by default composed by appending <code>/Palette</code> , so <code>DBZH/Palette</code> for example. The coloured image data is internally marked <code>temporary</code> and will not be saved in a HDF5 files by default. If one wishes to save a color image in the HDF5 structure, a quantity has to be given explicitly: </p><div class="fragment"><div class="line"><a class="code" href="namespacerack.html">rack</a> volume.h5 --select quantity=DBZH  --encoding quantity=DBZH_RGB --palette palette-DBZH.txt -o dbzh-rgb.h5</div>
</div><!-- fragment --><p> Another possibility is to remove the <code>temporary</code> marker with <code>&ndash;keep dataset:/data:</code> command. <br  />
 Note that colouring is implemented by data conversion; <code>Rack</code> does not currently support actual palette (lookup) objects in HDF5.</p>
<p>The comment lines starting with '#' are handled as well:</p><ul>
<li>the first comment in the file is the title of the palette</li>
<li>the last comment before a color entry is a label for that entry</li>
<li>other comments are discarded</li>
</ul>
<p>Entries associated with special data codes <code>undetect</code> and <code>nodata</code> &ndash; the actual values of which may vary &ndash; are prefixed with '@', and the preceding comment must contain the code key only in the short form (without leading <code>what:</code> ).</p>
<p>The palette information can be also converted to a graphic legend file using <code>&ndash;legendOut</code> command. The output is in Scalable Vector Graphics (SVG) format, displaying titles and labels described above. </p><div class="fragment"><div class="line"><span class="preprocessor"># Older versions:</span></div>
<div class="line"><a class="code" href="namespacerack.html">rack</a> --palette   palette-DBZH.txt --legendOut legend.svg</div>
<div class="line"><span class="preprocessor"># Current version:</span></div>
<div class="line"><span class="preprocessor">rack --paletteIn palette-DBZH.txt --legendOut legend.svg</span></div>
</div><!-- fragment --><p> The comment before each colour entry in the palette file will be displayed as lower limits in the legend. The SVG file can be converted to a pixel image using <code>convert</code> program, for example.</p>
<div class="image">
<img src="sweep-rgb2.png" alt=""/>
<div class="caption">
A sweep coloured with <code>--palette</code> command.</div></div>
 <p>The palette command can be applied to practically all the data objects: sweeps, polar products and Cartesian images, including composites.</p>
<p>The palette can be also provided in JSON (<a href="https://www.json.org/">https://www.json.org/</a>) format which is not as compact as the native syntax shown above but increases portability towards other languages like Python and JavaScript. The current naming and hierarchy is experimental, containing color definitions in <code>entries</code> , each entry essentially containing RGB <code>color</code> vector , minimum intensity <code>index</code> , and a description in English (<code>en</code>) . </p><div class="fragment"><div class="line">{</div>
<div class="line">     <span class="stringliteral">&quot;metadata&quot;</span>: {</div>
<div class="line">        <span class="stringliteral">&quot;title&quot;</span>: <span class="stringliteral">&quot;dBZ&quot;</span></div>
<div class="line">    },</div>
<div class="line">    <span class="stringliteral">&quot;entries&quot;</span>: {</div>
<div class="line">        <span class="stringliteral">&quot;id-01&quot;</span>: {</div>
<div class="line">            <span class="stringliteral">&quot;color&quot;</span>: [ 1, 1, 1 ], </div>
<div class="line">            <span class="stringliteral">&quot;en&quot;</span>: <span class="stringliteral">&quot;noise&quot;</span>, </div>
<div class="line">            <span class="stringliteral">&quot;index&quot;</span>: -32.0</div>
<div class="line">        }, </div>
<div class="line">        <span class="stringliteral">&quot;id-02&quot;</span>: {</div>
<div class="line">            <span class="stringliteral">&quot;color&quot;</span>: [ 255, 205, 20 ], </div>
<div class="line">            <span class="stringliteral">&quot;en&quot;</span>: <span class="stringliteral">&quot;rain&quot;</span>, </div>
<div class="line">            <span class="stringliteral">&quot;index&quot;</span>: 16.0</div>
<div class="line">        }, </div>
<div class="line">        <span class="stringliteral">&quot;id-03&quot;</span>: {</div>
<div class="line">            <span class="stringliteral">&quot;color&quot;</span>: [ 255, 150, 50 ], </div>
<div class="line">            <span class="stringliteral">&quot;en&quot;</span>: <span class="stringliteral">&quot;moderate&quot;</span>, </div>
<div class="line">            <span class="stringliteral">&quot;index&quot;</span>: 24.0</div>
<div class="line">        }, </div>
<div class="line">...</div>
<div class="line">        <span class="stringliteral">&quot;id-24&quot;</span>: {</div>
<div class="line">            <span class="stringliteral">&quot;color&quot;</span>: [ 255, 255, 255 ],</div>
<div class="line">            <span class="stringliteral">&quot;en&quot;</span>: <span class="stringliteral">&quot;nodata&quot;</span></div>
<div class="line">        }, </div>
<div class="line">        <span class="stringliteral">&quot;id-25&quot;</span>: {</div>
<div class="line">            <span class="stringliteral">&quot;color&quot;</span>: [ 0,  0,  0 ],</div>
<div class="line">            <span class="stringliteral">&quot;en&quot;</span>: <span class="stringliteral">&quot;undetect&quot;</span></div>
<div class="line">        }</div>
<div class="line">    } </div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="transparency"></a>
Adding transparency</h1>
<p>Adding transparency to radar images is useful in applications involving layered data viewing. Transparency can be added to gray or colour images with <code>&ndash;imageTransp</code> .</p>
<div class="fragment"></div><!-- fragment --><p>The first parameter, <code>threshold</code> defines the values to be transparent in the image. It can be one of the following</p><ul>
<li>A scalar threshold, under which all the values will be transparent.</li>
<li>A range <code>{min}</code>:{max} inside which full transparency (at <code>{min}</code> ) will linearly change to opaque (at <code>{max}</code> ).</li>
<li>A <em>functor</em> for more flexibly defining the transparency (documentation to appear)</li>
</ul>
<p>By default or explicitly issued <code>&ndash;iPhysical true</code>, it is handled as a physical values, like +5 (dBZ). This can be changed with <code>&ndash;iPhysical false</code> which uses interval [0,1] normalized by actual range of the current storage type, like [0,255] or [0,65535]. Instead of a threshold, a colon-separated range (eg. 5:15) can be given, yielding a smooth transition from transparent to opaque. By default, <code>undetect</code> is transparent and <code>nodata</code> is opaque. The following command creates a Cartesian image, adds palette and transparency to the image and stores the results in image files</p>
<div class="fragment"><div class="line"><span class="preprocessor"># Using physical threshold of 5dBZ (implicit --iPhysical true)</span></div>
<div class="line"><a class="code" href="namespacerack.html">rack</a> volume.h5 -Q DBZH -c --palette palette-DBZH.txt                   --imageTransp 5                -o cartesian-rgba1.png</div>
<div class="line"><span class="preprocessor"># Using a normalized, smooth threshold (10%:20%)</span></div>
<div class="line"><span class="preprocessor">rack volume.h5 -Q DBZH -c --palette palette-DBZH.txt --iPhysical false --imageTransp 0.1:0.2,undetect=0.2,nodata=0 -o cartesian-rgba2.png</span></div>
</div><!-- fragment --><p>The older command <code>&ndash;imageAlpha</code> uses linear scaling of data: either the original <code>gain</code>, <code>offset</code>, <code>undetect</code>, <code>nodata</code> or values overridden with <code>&ndash;encoding</code>. (The storage type cannot be changed.) The following command creates a Cartesian image, adds palette and transparency to the image and stores the results in image files:</p>
<div class="fragment"><div class="line"><a class="code" href="namespacerack.html">rack</a> volume.h5 -Q DBZH -c --palette palette-DBZH.txt -o cartesian-rgb.png --encoding C,0.2,-32,1,100 --imageAlpha -o cartesian-rgba.png</div>
</div><!-- fragment --><h1><a class="anchor" id="drainimage"></a>
Image processing commands</h1>
<p>In addition to the commands listed above, <b>Rack</b> provides several general image processing commands that can be used for smoothing, thresholding and rescaling image data - typically Cartesian products.</p>
<p>By default, the result is written in a new data array with a "new" <code>what:quantity</code> which is initially set to <code>${what:quantity}_${command}</code>, to be expanded as <code>DBZH_RESIZE</code> for example. Alternatively, a new quantity may be explicitly set with <code>quantity</code> parameter of <code>&ndash;encoding</code> command. To override source data, give an empty quantity attribute with <code>&ndash;encoding</code> <code>quantity=</code> which equals <code>&ndash;encoding</code> <code>'quantity=${what:quantity}'</code> .</p>
<p>The image processing commands have form <code>&ndash;i&lt;Command&gt;</code> . The <a class="el" href="imagespage.html#imageOps">List of image operators</a> is attached at the end of this page. Some selected examples are shown below.</p>
<p><b>Thresholding</b> data can be done as follows: </p><div class="fragment"><div class="line"><a class="code" href="namespacerack.html">rack</a> composite.h5 --iThreshold +10,-32,LIMIT=<span class="keyword">true</span>  -o compositeThresholdPhys.h5</div>
</div><!-- fragment --><p>Setting <code>LIMIT=true</code> prevents from underflow and overflow &ndash; especially when using <code>char</code> and <code>short</code> integers as storage types. By default, thresholding applies to <em>physical</em> intensity values. This can be changed with <code>&ndash;iPhysical</code> , to handle intensities as as raw (0) or physical (1) values. Hence, to threshold data with +10 dBZ, setting values below it to -32 dBZ, is done with: <br  />
 </p><div class="fragment"><div class="line"><a class="code" href="namespacerack.html">rack</a> composite.h5 --iPhysical <span class="keyword">false</span> --iThreshold 84,0  -o compositeThresholdRaw.h5</div>
</div><!-- fragment --><p>Radar data can fuzzified ie. mapped to interval [0.0,1.0] using various fuzzy operators. (See example of using <code>&ndash;iFuzzyStep</code> in <a class="el" href="accumulationpage.html#create_cluttermap">Application: creating clutter maps</a> ). In some cases, probability (<code>PROB</code> ) can be a suitable target quantity, set within <code>&ndash;encoding</code> .</p>
<p><b>Resizing</b> of all the data arrays in the first dataset&lt;1&gt; (typically dataset1) can be done as follows: </p><div class="fragment"><div class="line"><a class="code" href="namespacerack.html">rack</a> composite.h5 --iResize 500,500  -o composite500.h5</div>
</div><!-- fragment --><p>Like with many other commands, the data can be selected with <code>&ndash;select</code> or, for quantities only, more compactly with <code>-Q</code> : </p><div class="fragment"><div class="line"><a class="code" href="namespacerack.html">rack</a> composite.h5 -Q DBZH --iResize 500,500  -o composite500.h5</div>
<div class="line"><a class="code" href="namespacerack.html">rack</a> volume.h5 --select <span class="stringliteral">&#39;dataset2/data:,quantity=VRAD,count=3&#39;</span> --iResize 250,180 -o volume-small-VRAD.h5</div>
</div><!-- fragment --><p> <br  />
</p>
<p><b>Smoothing</b> an image can performed with sliding window based averaging. Rectangular, Gaussian and magnitude-saving "flow" averaging is supported:</p>
<div class="fragment"><div class="line"><a class="code" href="namespacerack.html">rack</a> composite.h5 -Q DBZH --iAverage         10:10 -o composite-avg.png</div>
<div class="line"><a class="code" href="namespacerack.html">rack</a> composite.h5 -Q DBZH --iGaussianAverage 10:10 -o composite-gaussian.png</div>
<div class="line"><a class="code" href="namespacerack.html">rack</a> composite.h5 -Q DBZH --iFlowAverage     10:10 -o composite-flowAvg.png</div>
</div><!-- fragment --><p>These method use weighted averaging is quality data (QIND) is associated. The last method (flow average) is suited to averaging vector fields, esp. if opposite vector components should not be simply cancelled. For the resulting vector, the direction of the sum vector is chosen and rescaled to the average magnitude.</p>
<p>Also <b>distance</b> <b>transform</b> yields blurred image data.</p>
<div class="fragment"><div class="line"><span class="preprocessor"># For data without quality field</span></div>
<div class="line"><a class="code" href="namespacerack.html">rack</a> composite.h5 -Q DBZH --iDistanceTransform    10:10 -o composite-dist.png</div>
<div class="line"><a class="code" href="namespacerack.html">rack</a> composite.h5 -Q DBZH --iDistanceTransformExp 10:10 -o composite-distExp.png</div>
<div class="line"><span class="preprocessor"># For data with quality field (QIND)</span></div>
<div class="line"><a class="code" href="namespacerack.html">rack</a> composite.h5 -Q DBZH --iDistanceTransformFill    10,10 -o composite-distFill.png</div>
<div class="line"><a class="code" href="namespacerack.html">rack</a> composite.h5 -Q DBZH --iDistanceTransformFillExp 10,10 -o composite-distFIllExp.png</div>
</div><!-- fragment --><p>Repeated blurring is compactly produced with BlenderOp which mixes the blurred image with the original image. It employs the abovementioned blurring methods. For mixing, it uses maximum or linear mixture. Respectively, if quality data (QIND) is available, it uses maximum-quality or quality-weighted methods.</p>
<div class="fragment"><div class="line"><a class="code" href="namespacerack.html">rack</a> composite.h5 -Q DBZH --iBlender 10:10,avg       -o composite-blended-avg.png</div>
<div class="line"><a class="code" href="namespacerack.html">rack</a> composite.h5 -Q DBZH --iBlender 10:10,avgGauss  -o composite-blended-avgGauss.png</div>
<div class="line"><a class="code" href="namespacerack.html">rack</a> composite.h5 -Q DBZH --iBlender 10:10,avgFlow   -o composite-blended-avgFlow.png</div>
</div><!-- fragment --><h2><a class="anchor" id="howimages"></a>
How it works internally</h2>
<p>In <b>Rack</b>, the data sets of a HDF structure are implemented directly as image objects. Copies of images are needed only if the intensities are rescaled or coloured. <br  />
 <b>Rack</b> has two memory arrays in which images can be extracted: <code>grayImage</code> and <code>colorImage</code>. In addition, there are two pointers: <code>grayImagePtr</code> and <code>imagePtr</code> . The flow of image data is illustrated below. <code>grayImagePtr</code> points to the latest HDF5 object processed or <code>grayImage</code> . <code>imagePtr</code> points to the latest HDF5 object processed, <code>grayImage</code> or <code>colorImage</code>. To be specific, these pointers point to the first HDF5 dataset matching the path selector <code>&ndash;select</code> , for example <code>/dataset1/data1/data</code> . The pointers are updated automatically by appropriate commands like <code>&ndash;image</code> or <code>&ndash;palette</code> . The flows implemented using pointers are illustrated with dotted lines.</p>
<div class="dotgraph">
<img src="dot_inline_dotgraph_5.png" alt="dot_inline_dotgraph_5.png" border="0" usemap="#dot_inline_dotgraph_5.map"/>
<map name="dot_inline_dotgraph_5.map" id="dot_inline_dotgraph_5.map"><area shape="rect" href="" title="Output file" alt="" coords="822,199,917,249"/>
<area shape="rect" href="volume" title="Input Volume,\nPolar product,\nCartesian product" alt="" coords="27,69,171,125"/>
<area shape="rect" href="gray_image" title="&lt;i&gt;Gray image|&lt;alpha&gt;alpha channel\n(optional)" alt="" coords="272,84,391,151"/>
<area shape="rect" href="color_image" title="&lt;i&gt;Color image|&lt;alpha&gt;alpha channel\n(optional)" alt="" coords="810,107,929,173"/>
</map>
</div>
<h2><a class="anchor" id="imageOps"></a>
List of image operators</h2>
<div class="fragment"></div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
<div class="ttc" id="anamespacerack_html"><div class="ttname"><a href="namespacerack.html">rack</a></div><div class="ttdef"><b>Definition:</b> AndreOp.h:45</div></div>
<!-- HTML footer for doxygen 1.8.17-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
